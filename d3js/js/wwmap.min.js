var wwMap=function(){function y(){var e=document.getElementById("wrapperdiv");document.body.removeChild(e);var t=document.getElementById("fallback-text");t.className="show";var n=document.createElement("img");n.setAttribute("src","images/fallback.png"),document.body.appendChild(n)}function b(e,t){range=[];for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];for(var r in n)n.hasOwnProperty(r)&&range.push(n[r])}return range}function w(e){var t=e.toString().split(".");return t[0].replace(/\B(?=(\d{3})+(?!\d))/g,",")}function E(e){return e.charAt(0).toUpperCase()+e.slice(1)}function S(e,t){t=typeof t=="undefined"?!1:t;if(r.hasOwnProperty(e))return t?E(r[e]):r[e];console.log("Could not find translation of "+e)}function x(e,t,n){var r=S(t,n);r&&d3.select(e).text(r)}function T(e,t,n){var r=S(t,n);r&&d3.select(e).html(r)}function N(e,t,n){var r=S(t,n);r&&d3.select(e).attr("title",r)}function C(e,t,n){var r=S(t,n);if(r){var i=d3.select(e),s=i.html();i.html(r+s.substring(s.indexOf("<")))}}function k(){x("#fallback-title","Africa Water Map"),T("#fallback-text","browser fallback"),C("#map-info-title","map info title"),C(".map-info > h1 > span.big",o),T(".instructions","instructions"),x("#select-water-source","water",!0),x("#select-sanitation-source","sanitation",!0),x("#reset-button","Reset"),C(".social-share > h2","share"),N("#twitter-search-link","follow africa water map"),N(".ss-share-link.ico-facebook","share on facebook"),N(".ss-share-link.ico-twitter","share on twitter"),N(".ss-share-link.ico-google","share on google"),N(".ss-share-link.ico-linkedin","share on linkedin"),N(".ss-share-link.ico-embed","embed this map"),C(".embed-example","you can embed this map"),x(".targets-title","Everyone, Everywhere by 2030"),x(".currently > .targets-section-title","currently"),x(".for-target > .targets-section-title","for targets"),x(".for-target > .targets-detail","extra people per year"),T(".targets-percent","That is just % of the population"),x(".map-description > h3","about this map"),x("#description-about","this map shows which ..."),x("#description-more-info > a","find out more"),x("#map-by","map by")}function L(){var e=d3.select(".embed-example");e.style("display")=="none"?e.style("display","block"):e.style("display","none")}function A(){var t=window.location!=window.parent.location?document.referrer:document.location,n=encodeURIComponent(t),r;o=="water"?r=e.twitterHashTagWater:r=e.twitterHashTagSanitation;var i=encodeURIComponent(S("twitter share text "+o)),s=encodeURIComponent(S("other share text "+o)),u=encodeURIComponent(S("Africa Water Week"));d3.select("#twitter-search-link").attr("href","https://twitter.com/#"+r).text(" #"+r),d3.select(".ss-share-link.ico-facebook").attr("href","https://www.facebook.com/sharer.php?s=100&p[title]="+u+"&p[summary]="+s+"&p[url]="+n),d3.select(".ss-share-link.ico-twitter").attr("href","https://twitter.com/share?text="+i+"&url="+n+"&hashtags=africawaterweek"),d3.select(".ss-share-link.ico-google").attr("href","https://plus.google.com/share?url="+n),d3.select(".ss-share-link.ico-linkedin").attr("href","https://www.linkedin.com/shareArticle?mini=true&url="+n+"&title="+u+"&summary="+s);var a=document.getElementsByTagName("meta");for(var f=0;f<a.length;f++)a[f].getAttribute("property")=="og:description"&&(a[f].content=s),a[f].getAttribute("property")=="og:title"&&(a[f].content=u)}function O(){A(),d3.select(".ss-share-link.ico-embed").on("click",L)}function M(){g.hasOwnProperty("logo")&&g.logo=="none"&&d3.select(".logos").selectAll("*").remove()}function _(e,t,n,r,i){var s;i?s="person "+i:s="person",e.append("circle").attr("cx",t+.2*r).attr("cy",n+.15*r).attr("r",.15*r).attr("class",s),e.append("rect").attr("x",t).attr("y",n+.25*r).attr("width",.4*r).attr("height",.45*r).attr("class",s),e.append("rect").attr("x",t+.1*r).attr("y",n+.7*r).attr("width",.2*r).attr("height",.3*r).attr("class",s)}function D(e,t,n,r,i,s){for(var o=0;o<e;o++)_(t,n+o*i/2,r,i,s)}function P(e,t,n){var r,i,s;n=="current"?(r=".currently > .targets-people",i="current",s=!0):(r=".for-target > .targets-people",i="target",s=!1),e=Math.round(e),t=Math.round(t);var o=d3.select(r);o.selectAll("*").remove();var u=o.append("div"),a=parseInt(u.style("width")),f;e<=10?f=.25*a:f=.5*a;var l=.2*a,c=u.append("svg:svg").attr("id","country-targets-vis").attr("width",a).attr("height",f),h=0,p=0;s&&(e<=10?h=(10-e)*(l/2):h=(20-e)*(l/2)),e<=10?D(e,c,h,p,l,i):e<=20?(D(10,c,0,p,l,i),p=l*1.2,D(e-10,c,h,p,l,i)):console.log("Can't draw more than 20 people")}function H(t){var n=e.personFullHeight,r=n,i=n,s=d3.select("#targets-key-person");s.selectAll("*").remove();var o=s.append("svg:svg").attr("id","country-targets-vis").attr("width",r).attr("height",i);D(1,o,0,0,n,"key");var u=" = "+w(t)+" "+S("people");d3.select("#targets-key-text").text(u)}function B(e){return t.hasOwnProperty(e)&&t[e].hasOwnProperty(o+"_initial")&&t[e].hasOwnProperty(o+"_increase")?!0:!1}function j(e){return t.hasOwnProperty(e)&&t[e].hasOwnProperty(o+"_pop_current")&&t[e].hasOwnProperty(o+"_pop_universal")?!0:!1}function F(t){if(B(t)){var n=et(i,e.maxYear);return n>99.9?-1:(100-n)/(e.maxYear-e.thisYear)}return-1}function I(e,t){maxNumber=Math.max(Math.abs(e),Math.abs(t)),minNumber=Math.min(Math.abs(e),Math.abs(t));var n={number:1e3,abbrev:S("one_letter_1000")},r={number:1e6,abbrev:S("one_letter_1000000")};return minNumber==0?maxNumber<1e6?n:r:maxNumber<1e6?n:minNumber>=1e5?r:n}function q(e,t){return e/=t.number,e<10?e.toFixed(1):Math.round(e)}function R(e,t){return maxNumber=Math.max(Math.abs(e),Math.abs(t)),maxNumber<2e4?1e3:maxNumber<2e5?1e4:maxNumber<2e6?1e5:maxNumber<2e7?1e6:1e7}function U(){d3.select(".selected-country-border").remove()}function z(){d3.select(".selected-country-border").attr("class","selected-country-border "+o)}function W(){U();var e=topojson.mesh(n,n.objects.subunits,function(e,t){return e.id==i||t.id==i});a.append("path").datum(e).attr("d",u).attr("class","selected-country-border "+o)}function X(e){B(e.id)&&(i=e.id,ft(),W())}function V(e){var t=et(e.id,s);if(t==null)return;var n=Z(e.id),r=Math.max(6,n.length*.6);d3.select(".tooltip-year").text(s.toString()),d3.select(".tooltip-country").text(n),d3.select(".tooltip-percent").text(t.toFixed(1)+"%"),c.transition().duration(200).style("opacity",.9);var i=d3.select("#map")[0][0].getBoundingClientRect();c.style("width",r+"em").style("left",d3.event.pageX-i.left+10+"px").style("top",d3.event.pageY-i.top-130+"px")}function $(e){c.transition().duration(500).style("opacity",0)}function J(){d3.select("a.d3-slider-handle").text(s.toString())}function K(){d3.select(".country-info-year").text(s.toString())}function Q(){var t;o=="water"?t=e.waterColorRange:t=e.sanitationColorRange,f=d3.scale.threshold().domain(v).range(t)}function G(e,t){s=t,J(),K(),ot(),st(),ct()}function Y(e){o=e,d3.select("#wrapperdiv").attr("class","wrapper "+o),it(),st(),Q(),rt(),ct(),ft(),z(),A()}function Z(e){return t.hasOwnProperty(e)?S(t[e].name):"unknown"}function et(n,r){if(B(n)){var i=t[n][o+"_initial"],s=t[n][o+"_increase"],u=r-e.minYear;return Math.min(100,i+u*s)}return null}function tt(n){if(B(n)){var r=t[n][o+"_initial"],i=t[n][o+"_increase"];return i<=0?null:Math.round((100-r)/i)+e.minYear}return null}function nt(){var e={};for(var n in t)if(t.hasOwnProperty(n)){var r=et(n,s);r!=null&&(e[n]=r)}return e}function rt(){var e=d3.select("#map-legend-svg");e.selectAll("*").remove();var t=m.length,n=parseInt(e.style("width")),r=Math.floor((n-t)/t),i=r,s=(r+1)*(t+1),u=e.append("svg").attr("width",s).attr("height",i).style("margin","auto"),a=u.selectAll("g.legend").data(m).enter().append("g").attr("class","legend");a.append("rect").attr("x",function(e,t){return(r+1)*t}).attr("y",0).attr("width",r).attr("height",i).style("fill",function(e,t){return f(e)}).style("opacity",.8),o=="water"?title=S("access to water"):title=S("access to sanitation"),d3.select("#map-legend-label").text(title)}function it(){d3.select(".map-info > h1 > span.big").attr("class","big "+o).text(S(o)).append("strong").text(" "+e.minYear.toString()+"-"+e.maxYear.toString()),o=="water"?(d3.select("#select-water-source").attr("class","button source current-source"),d3.select("#select-sanitation-source").attr("class","button source")):(d3.select("#select-water-source").attr("class","button source"),d3.select("#select-sanitation-source").attr("class","button source current-source"))}function st(){var e,t=et(i,s).toFixed(1);o=="water"?e=S("of people have access to water"):e=S("of people have access to sanitation");var n=d3.select("#country-info-access-text");n.selectAll("*").remove();var r=n.append("span").attr("class","access-percentage").text(t);r.append("span").attr("class","percent-sign").text("%"),n.append("span").text(" "+e+" "),n.append("span").attr("class","in-year").text("in "+s.toString()),n.append("span").attr("class","actual-projected").text(" ("+S("actual and projected")+")")}function ot(){}function ut(){var t=d3.select("#country-info");t.selectAll("*").remove(),t.append("div").attr("class","country-info-year").text(s.toString()),t.append("h2").text(Z(i)),t.append("p").attr("id","country-info-access-text"),st();var n=t.append("div").attr("id","country-info-graph"),r=n.append("div").attr("class","inner"),o=parseInt(r.style("width")),u=e.lineGraphAspectRatio*o,a={left:30,right:15,top:6,bottom:20};d=d3.scale.linear().domain([0,100]).range([0+a.bottom,u-a.top]),p=d3.scale.linear().domain([e.minYear,e.maxYear]).range([0+a.left,o-a.right]);var f=r.append("svg:svg").attr("width",o).attr("height",u);h=f.append("svg:g").attr("transform","translate(0, "+u.toString()+")");var l=et(i,e.minYear),c=et(i,e.thisYear),v=et(i,e.maxYear);h.append("svg:line").attr("class","history").attr("x1",p(e.minYear)).attr("y1",-1*d(l)).attr("x2",p(e.thisYear)).attr("y2",-1*d(c));if(v>99.9){var m=tt(i);h.append("svg:line").attr("class","projection").attr("x1",p(e.thisYear)).attr("y1",-1*d(c)).attr("x2",p(m)).attr("y2",-1*d(100)),h.append("svg:line").attr("class","projection").attr("x1",p(m)).attr("y1",-1*d(100)).attr("x2",p(e.maxYear)).attr("y2",-1*d(100))}else h.append("svg:line").attr("class","projection").attr("x1",p(e.thisYear)).attr("y1",-1*d(c)).attr("x2",p(e.maxYear)).attr("y2",-1*d(v)),h.append("svg:line").attr("class","universal").attr("x1",p(e.thisYear)).attr("y1",-1*d(c)).attr("x2",p(e.maxYear)).attr("y2",-1*d(100));h.append("svg:line").attr("class","axis").attr("x1",p(e.minYear)).attr("y1",-1*d(0)).attr("x2",p(e.maxYear)).attr("y2",-1*d(0)),h.append("svg:line").attr("class","axis").attr("x1",p(e.minYear)).attr("y1",-1*d(0)).attr("x2",p(e.minYear)).attr("y2",-1*d(100)),h.selectAll(".xLabel").data(e.yearsOnGraph).enter().append("svg:text").attr("class","xLabel").text(String).attr("x",function(e){return p(e)}).attr("y",0).attr("text-anchor","middle"),h.selectAll(".yLabel").data(d.ticks(3)).enter().append("svg:text").attr("class","yLabel").text(String).attr("x",0).attr("y",function(e){return-1*d(e)}).attr("text-anchor","right").attr("dy",4),h.selectAll(".xTicks").data(e.yearsOnGraph).enter().append("svg:line").attr("class","xTicks").attr("x1",function(e){return p(e)}).attr("y1",-1*d(0)).attr("x2",function(e){return p(e)}).attr("y2",-1*d(-5)),h.selectAll(".yTicks").data(d.ticks(3)).enter().append("svg:line").attr("class","yTicks").attr("x1",p(e.minYear)).attr("y1",function(e){return-1*d(e)}).attr("x2",p(e.minYear-1)).attr("y2",function(e){return-1*d(e)}),ot()}function at(){if(j(i)){var e=1e3*t[i][o+"_pop_current"],n=1e3*t[i][o+"_pop_universal"]-e;n<10&&(n=0);var r=I(e,n),s=q(e,r),u=q(n,r);d3.select(".currently .targets-number-digits").text(s),d3.select(".currently .targets-number-unit").text(r.abbrev),n>0?(d3.select(".for-target .targets-number-digits").text(u),d3.select(".for-target .targets-number-unit").text(r.abbrev)):(d3.select(".for-target .targets-number-digits").text("0"),d3.select(".for-target .targets-number-unit").text(""));var a=F(i);a>0?(d3.select(".targets-percent").style("visibility","visible"),d3.select(".targets-percent-digits").text(a.toFixed(1))):d3.select(".targets-percent").style("visibility","hidden");var f=R(e,n),l=e/f,c=n/f,h=Math.max(l,c);P(l,h,"current"),P(c,h,"target"),H(f),d3.select(".targets-key").style("visibility","visible"),o=="water"?(d3.select(".targets-subtitle").text(S("Total number of new people gaining access to water")),d3.select(".currently > .targets-detail").text(S("more people per year will gain access to water"))):(d3.select(".targets-subtitle").text(S("Total number of new people gaining access to sanitation")),d3.select(".currently > .targets-detail").text(S("more people per year will gain access to sanitation")))}else d3.select(".currently .targets-number-digits").text(""),d3.select(".currently .targets-number-unit").text("no data"),d3.select(".for-target .targets-number-digits").text(""),d3.select(".for-target .targets-number-unit").text("no data"),d3.select(".targets-percent").style("visibility","hidden"),P(0,0,"current"),P(0,0,"target"),d3.select(".targets-key").style("visibility","hidden")}function ft(){ut(),at()}function lt(t,n){return t.hasOwnProperty(n)?f(t[n]):e.noDataColor}function ct(){var e=nt();a.selectAll(".country").style("fill",function(t){return lt(e,t.id)})}function ht(){d3.select("#year-slider").selectAll("*").remove(),l=d3.select("#year-slider").call(d3.slider().axis(!0).min(e.minYear).max(e.maxYear).step(1).value(s).on("slide",G)),J()}function pt(e,i,s,o){t=s,n=i,r=o,k();var f=topojson.feature(i,i.objects.subunits).features,l=topojson.mesh(i,i.objects.subunits,function(e,t){return!0});Q(),a.selectAll(".subunit").data(f).enter().append("path").attr("d",u).attr("class",function(e){return"country "+e.id}).on("click",X).on("mouseover",V).on("mouseout",$),ct(),a.append("path").datum(l).attr("d",u).attr("class","country-border"),rt(),ft(),ht(),O(),M(),c.style("opacity",0)}function dt(){i=e.initialCountry,s=e.thisYear}function vt(t){e=t;if(!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image","1.1")){y();return}o=e.initialSource,dt();var n=parseInt(d3.select("#map").style("width")),r=1.1,i=n*r;v=[10,20,30,40,50,60,70,80,90,101],m=[1,10,20,30,40,50,60,70,80,90,100];var s="en";g.hasOwnProperty("lang")&&(s=g.lang);var f="data/lang_"+s+".json",l=d3.geo.mercator().scale(n/1.25).translate([n/4,i/2+10]);u=d3.geo.path().projection(l),d3.select("#select-water-source").on("click",function(e){Y("water")}),d3.select("#select-sanitation-source").on("click",function(e){Y("sanitation")}),d3.select("#reset-button").on("click",mt),a=d3.select("#map").insert("svg","div.tooltip").attr("width",n).attr("height",i).attr("class","map-svg"),c=d3.select("#map > .tooltip"),queue().defer(d3.json,e.mapurl_topojson).defer(d3.json,e.dataurl).defer(d3.json,f).await(pt)}function mt(){dt(),s=e.minYear,ht(),st(),Q(),rt(),ct(),ft(),U()}var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g=function(){var e={},t=window.location.search.substring(1),n=t.split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(typeof e[i[0]]=="undefined")e[i[0]]=i[1];else if(typeof e[i[0]]=="string"){var s=[e[i[0]],i[1]];e[i[0]]=s}else e[i[0]].push(i[1])}return e}();return{init:vt}}();