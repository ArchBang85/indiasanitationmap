var wwMap=(function(){var D,z,m,E,x,r,o,q,n,B,v,a;function H(){var J=navigator.userAgent.toLowerCase();if(J.indexOf("msie")!=-1){var I=parseInt(J.split("msie")[1]);if(I<=8){return true}}return false}function h(I,J){range=[];for(var J in I){if(I.hasOwnProperty(J)){var K=I[J];for(var L in K){if(K.hasOwnProperty(L)){range.push(K[L])}}}}return range}function G(I){if(z.hasOwnProperty(I)){if(z[I].hasOwnProperty(o+"_initial")&&z[I].hasOwnProperty(o+"_increase")){return true}}return false}function c(I){if(G(I.id)){x=I.id;b()}}function t(J){var I=F(J.id,r);if(I==null){return}a.transition().duration(200).style("opacity",0.9);a.html(J.properties.name+"<br />"+I.toFixed(1)+"%").style("left",(d3.event.pageX)+"px").style("top",(d3.event.pageY-28)+"px")}function l(I){a.transition().duration(500).style("opacity",0)}function i(){d3.select("a.d3-slider-handle").text(r.toString())}function C(){var I;if(o=="water"){I=D.waterColorRange}else{I=D.sanitationColorRange}B=d3.scale.threshold().domain([10,20,30,40,50,60,70,80,90,101]).range(I)}function u(I,J){r=J;i();y();d()}function g(I){o=I;y();C();d();b()}function e(I){if(z.hasOwnProperty(I)){return z[I]["name"]}return"unknown"}function F(J,K){if(G(J)){var I=z[J][o+"_initial"];var M=z[J][o+"_increase"];var L=K-D.minYear;return Math.min(100,I+(L*M))}return null}function f(J){if(G(J)){var I=z[J][o+"_initial"];var K=z[J][o+"_increase"];if(K<=0){return null}return Math.round((100-I)/K)+D.minYear}return null}function p(){var K={};for(var I in z){if(z.hasOwnProperty(I)){var J=F(I,r);if(J!=null){K[I]=J}}}return K}function k(K){var I=[];for(var J=D.minYear;J<=D.maxYear;J++){if(K.hasOwnProperty(J.toString())){I.push(K[J.toString()])}}return I}function s(I){options={title:I,fill:true};colorlegend("#map-legend",B,"linear",options)}function y(){d3.select("#country-info-access-text").text(F(x,r).toFixed(1)+"% of people have access to "+o+" in "+r.toString())}function b(){var M=20;var P=d3.scale.linear().domain([0,100]).range([0+M,E.height-M]);var Q=d3.scale.linear().domain([D.minYear,D.maxYear]).range([0+M,E.width-M]);d3.select("#country-info").selectAll("*").remove();var K=d3.select("#country-info");K.append("h2").text(e(x));K.append("p").attr("id","country-info-access-text");y();var J=K.append("svg:svg").attr("id","country-info-graph").attr("width",E.width).attr("height",E.height);var N=J.append("svg:g").attr("transform","translate(0, "+E.height.toString()+")");var R=F(x,D.minYear);var O=F(x,D.thisYear);var I=F(x,D.maxYear);N.append("svg:line").attr("class","history").attr("x1",Q(D.minYear)).attr("y1",-1*P(R)).attr("x2",Q(D.thisYear)).attr("y2",-1*P(O));if(I>99.9){var L=f(x);N.append("svg:line").attr("class","projection").attr("x1",Q(D.thisYear)).attr("y1",-1*P(O)).attr("x2",Q(L)).attr("y2",-1*P(100));N.append("svg:line").attr("class","projection").attr("x1",Q(L)).attr("y1",-1*P(100)).attr("x2",Q(D.maxYear)).attr("y2",-1*P(100))}else{N.append("svg:line").attr("class","projection").attr("x1",Q(D.thisYear)).attr("y1",-1*P(O)).attr("x2",Q(D.maxYear)).attr("y2",-1*P(I));N.append("svg:line").attr("class","universal").attr("x1",Q(D.thisYear)).attr("y1",-1*P(O)).attr("x2",Q(D.maxYear)).attr("y2",-1*P(100))}N.append("svg:line").attr("class","axis").attr("x1",Q(D.minYear)).attr("y1",-1*P(0)).attr("x2",Q(D.maxYear)).attr("y2",-1*P(0));N.append("svg:line").attr("class","axis").attr("x1",Q(D.minYear)).attr("y1",-1*P(0)).attr("x2",Q(D.minYear)).attr("y2",-1*P(100));N.selectAll(".xLabel").data(D.yearsOnGraph).enter().append("svg:text").attr("class","xLabel").text(String).attr("x",function(S){return Q(S)}).attr("y",0).attr("text-anchor","middle");N.selectAll(".yLabel").data(P.ticks(3)).enter().append("svg:text").attr("class","yLabel").text(String).attr("x",0).attr("y",function(S){return -1*P(S)}).attr("text-anchor","right").attr("dy",4);N.selectAll(".xTicks").data(D.yearsOnGraph).enter().append("svg:line").attr("class","xTicks").attr("x1",function(S){return Q(S)}).attr("y1",-1*P(0)).attr("x2",function(S){return Q(S)}).attr("y2",-1*P(-5));N.selectAll(".yTicks").data(P.ticks(3)).enter().append("svg:line").attr("class","yTicks").attr("x1",-1*Q(D.minYear)).attr("y1",function(S){return -1*P(S)}).attr("x2",-1*Q(D.minYear-3)).attr("y2",function(S){return -1*P(S)})}function j(I,J){if(I.hasOwnProperty(J)){return B(I[J])}else{return D.noDataColor}}function d(){var I=p();n.selectAll(".country").style("fill",function(J){return j(I,J.id)})}function A(J,M,L){z=L;var I=topojson.feature(M,M.objects.subunits).features;var K=topojson.mesh(M,M.objects.subunits,function(O,N){return true});C();n.selectAll(".subunit").data(I).enter().append("path").attr("d",q).attr("class",function(N){return"country "+N.id}).on("click",c).on("mouseover",t).on("mouseout",l);d();n.append("path").datum(K).attr("d",q).attr("class","country-border");s("Water stuff");b()}function w(M){D=M;m=H();x="Africa";o=D.initialSource;r=D.thisYear;var L=parseInt(d3.select("#map").style("width"));var K=1;var J=L*K;E={height:140,width:240};var I=d3.geo.mercator().scale(L/1.25).translate([L/4,J/2+10]);q=d3.geo.path().projection(I);d3.select("#select-water-source").on("click",function(N){g("water")});d3.select("#select-sanitation-source").on("click",function(N){g("sanitation")});n=d3.select("#map").append("svg").attr("width",L).attr("height",J).attr("class","map-svg");a=d3.select("#map").append("div").attr("class","tooltip").style("opacity",0);queue().defer(d3.json,D.mapurl_topojson).defer(d3.json,D.dataurl).await(A);v=d3.select("#year-slider").call(d3.slider().axis(true).min(D.minYear).max(D.maxYear).step(1).value(r).on("slide",u));i()}return{init:w}})();